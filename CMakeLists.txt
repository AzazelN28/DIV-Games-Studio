# CMAKE lists file for FUZE BASIC V2.0+
# (c) 2015 Mike Green and the FUZE Teame

CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(div2015)

IF(APPLE)
SET (PLATFORM "OSX")
ENDIF()

IF(WIN32)
SET (PLATFORM "WIN")
ENDIF()


#INCLUDE ( tools/git.cmake )
#INCLUDE( tools/welcome.cmake )
#INCLUDE( tools/defaults.cmake )
# The name of our binary
IF(NOT DEFINED TARGET)
	SET(TARGET "div") 
ENDIF()

SET(RUNTIME "divrun")
SET(DEBUG "divdbg")
SET(RUNNER "d")

#IF(NOT EXISTS build.conf)
#	MESSAGE("-- NO BUILD.CONF FOUND!")
#	MESSAGE("-- Creating a default one")
#	EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E copy tools/build.conf.default build.conf)
#	IF(EXISTS build.conf)
#		MESSAGE("-- done")
#	ENDIF()
#ENDIF()

#INCLUDE( build.conf )

# Check platform
# Currently detects osx and pi
#IF(NOT DEFINED PLATFORM OR PLATFORM STREQUAL "AUTO")
#	INCLUDE (tools/platform.cmake)
#ENDIF()

IF(NOT DEFINED PLATFORM OR PLATFORM STREQUAL "AUTO")
#	MESSAGE("WHOOPS! NO PLATFORM DETECTED!")
	SET(PLATFORM "LINUX")
ENDIF()

INCLUDE(FindPkgConfig)

PKG_SEARCH_MODULE(SDL REQUIRED sdl)
PKG_SEARCH_MODULE(SDLIMAGE REQUIRED SDL_image>=1.2.0)
PKG_SEARCH_MODULE(SDLMIXER REQUIRED SDL_mixer>=1.2.0)

include_directories(${SDL_INCLUDE_DIRS})
include_directories(${SDLIMAGE_INCLUDE_DIRS})
include_directories(${SDLMIXER_INCLUDE_DIRS})

set(EXTRA_LIBS ${SDL_LIBRARIES} ${SDLIMAGE_LIBRARIES} ${SDLMIXER_LIBRARIES})

# include our SDL stuff
# this includes TTF
#IF(SDL GREATER 0)
#	MESSAGE("-- Including SDL(${SDL})")
#	SET(TARGET ${TARGET}-SDL${SDL})
#	INCLUDE (tools/sdl.cmake)
#ENDIF()


# generate keywordTokens.h from
# new script that doesn't rely
# on csh
#INCLUDE ( tools/dxtokens.cmake )

# default definitions
ADD_DEFINITIONS( -D_GNU_SOURCE )

INCLUDE_DIRECTORIES(src runtime)
FILE(GLOB DIV_SOURCES "src/*.c")
FILE(GLOB VISOR_SOURCES "visor/*.c")
FILE(GLOB RUNTIME_SOURCES "runtime/*.c")
FILE(GLOB DEBUG_SOURCES "runtime/debug/*.c")
IF ( MODE8 ) 
FILE(GLOB VPE_SOURCES "runtime/vpe/*.c")
ENDIF()

#INCLUDE (tools/plugins.cmake)

ADD_DEFINITIONS( -D${PLATFORM} )

#SET(TARGET ${TARGET}-${PLATFORM} ) #-${GIT_BRANCH}-${GIT_COMMIT_HASH})

# make this a c++ app
#IF(CPLUSPLUS) 
SET_SOURCE_FILES_PROPERTIES(${VPE_SOURCES} ${RUNTIME_SOURCES} ${DEBUG_SOURCES} ${DIV_SOURCES} ${VISOR_SOURCES} PROPERTIES LANGUAGE C)
ADD_DEFINITIONS( -g -fpermissive -funsigned-char -w )

IF(APPLE)
ADD_DEFINITIONS( -ferror-limit=1 -D__WORDSIZE=64 )
SET( CMAKE_EXE_LINKER_FLAGS  "-lSDLmain -lSDL -framework Cocoa" )
ENDIF()

#set ( CMAKE_CXX_FLAGS "-m32")
#SET (TARGET ${TARGET}-CXX)
#ENDIF()


ADD_EXECUTABLE(
	${TARGET} 
	src/global.h
	${VISOR_SOURCES}
	${DIV_SOURCES} 
)

ADD_EXECUTABLE(
	${RUNTIME} 
	runtime/inter.h
	${RUNTIME_SOURCES} ${VPE_SOURCES} src/osdep.c
)

ADD_EXECUTABLE(
	${DEBUG} 
	runtime/inter.h runtime/include.div
	${RUNTIME_SOURCES} ${DEBUG_SOURCES} ${VPE_SOURCES} src/osdep.c
)

ADD_EXECUTABLE(
	${RUNNER}
	src/runner/r.c
)

IF ( MODE8 ) 
TARGET_COMPILE_DEFINITIONS( ${DEBUG} PRIVATE -DDEBUG -DMODE8)
TARGET_COMPILE_DEFINITIONS( ${RUNTIME} PRIVATE -DMODE8)
ELSE()
TARGET_COMPILE_DEFINITIONS( ${DEBUG} PRIVATE -DDEBUG)
TARGET_COMPILE_DEFINITIONS( ${RUNTIME} PRIVATE )
ENDIF()
 
find_package( ZLIB REQUIRED )
if ( ZLIB_FOUND )
    include_directories( ${ZLIB_INCLUDE_DIRS} )
    target_link_libraries( ${TARGET} ${ZLIB_LIBRARIES} )
    target_link_libraries( ${RUNTIME} ${ZLIB_LIBRARIES} )
    target_link_libraries( ${DEBUG} ${ZLIB_LIBRARIES} )

endif( ZLIB_FOUND )


TARGET_LINK_LIBRARIES(${TARGET} ${EXTRA_LIBS} ${SDLGFX_LIBS} jpeg m)
TARGET_LINK_LIBRARIES(${RUNTIME} ${EXTRA_LIBS} ${SDLGFX_LIBS} jpeg m)
TARGET_LINK_LIBRARIES(${DEBUG} ${EXTRA_LIBS} ${SDLGFX_LIBS} jpeg m)


SET_DIRECTORY_PROPERTIES(PROPERTIES  ADDITIONAL_MAKE_CLEAN_FILES system/${TARGET} system/{$DEBUG} system/{$RUNNER} CMakeCache.txt CMakeFiles )

#ADD_CUSTOM_COMMAND(
#	TARGET ${TARGET}
#	COMMENT "-- Linking Executable ${TARGET}"
#	PRE_LINK
#)

ADD_CUSTOM_COMMAND(
	TARGET ${TARGET}
	DEPENDS ${TARGET}
	COMMAND ${CMAKE_COMMAND} -E rename ${TARGET} system/${TARGET}
	COMMENT "-- COPYING ${TARGET} to div"
	POST_BUILD
)
ADD_CUSTOM_COMMAND(
	TARGET ${RUNTIME}
	DEPENDS ${RUNTIME}
	COMMAND ${CMAKE_COMMAND} -E rename ${RUNTIME} system/${RUNTIME}
	COMMENT "-- COPYING ${TARGET} to div"
	POST_BUILD
)
ADD_CUSTOM_COMMAND(
	TARGET ${DEBUG}
	DEPENDS ${DEBUG}
	COMMAND ${CMAKE_COMMAND} -E rename ${DEBUG} system/${DEBUG}
	COMMENT "-- COPYING ${TARGET} to div"
	POST_BUILD
)


#IF(DEBUG EQUAL 0) 
#ADD_CUSTOM_COMMAND(
#	TARGET ${TARGET}
#	DEPENDS ${TARGET}
#	COMMAND ${CMAKE_COMMAND} -E copy ${TARGET} fuzebasic-3/fuzebasic-3.0.0/fuze
#	COMMENT "-- Some package prep.."
#	POST_BUILD
#)
#ENDIF()

#IF(GTK EQUAL 3) 
#ENDIF()
